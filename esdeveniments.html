<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Esdeveniments d'Estiu</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom scrollbar for better aesthetics */
        .overflow-y-auto::-webkit-scrollbar {
            width: 8px;
        }
        .overflow-y-auto::-webkit-scrollbar-track {
            background: #2d3748; /* bg-gray-800 */
            border-radius: 10px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background: #6366f1; /* bg-indigo-600 */
            border-radius: 10px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background: #4f46e5; /* hover:bg-indigo-700 */
        }

        /* Leaflet Map styles */
        #map {
            height: 100%;
            width: 100%;
            border-radius: 0.5rem;
        }
    </style>
    <!-- Leaflet CSS for the map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
</head>
<body class="bg-gray-900 font-sans text-gray-100 p-4 sm:p-8">

    <div class="max-w-3xl mx-auto">
        <header class="flex items-center mb-8">
            <span class="text-indigo-400 text-4xl mr-4">&#x1F4C5;</span> <!-- Icona de calendari -->
            <h1 class="text-5xl font-extrabold text-white">Esdeveniments d'estiu</h1>
        </header>

        <div class="mb-8 flex space-x-4">
            <!-- S'han eliminat els botons "Tots els Esdeveniments" i "Agost i Setembre" -->
        </div>

        <div id="events-container" class="space-y-6">
            <p id="loading-message" class="text-center text-xl text-indigo-400 animate-pulse">Carregant esdeveniments...</p>
        </div>
    </div>

    <!-- Event Detail Modal -->
    <div id="event-detail-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-gray-900 rounded-lg shadow-2xl max-w-2xl w-full p-6 relative border border-indigo-700 max-h-[90vh] overflow-y-auto">
            <button id="close-modal-btn" class="absolute top-3 right-3 text-gray-400 hover:text-white text-2xl font-bold transition-colors duration-200">
                &times;
            </button>
            <img id="modal-image" src="" alt="" class="w-40 h-40 rounded-full object-cover mx-auto mb-6 border-4 border-indigo-500" onerror="this.onerror=null;this.src='https://placehold.co/160x160/6366f1/ffffff?text=Event';">
            <h2 id="modal-name" class="text-3xl font-extrabold text-white text-center mb-3"></h2>
            <p id="modal-datetime" class="text-indigo-400 text-lg text-center mb-4"></p>
            <div class="text-gray-300 space-y-3 pr-2">
                <p><strong>Lloc:</strong> <span id="modal-location"></span></p>
                <p><strong>Entrada:</strong> <span id="modal-price"></span></p>
                <p><strong>Tipus:</strong> <span id="modal-type"></span></p>
                <div class="mt-4">
                    <a id="modal-map-link" href="#" target="_blank" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white font-bold rounded-full shadow-lg hover:bg-blue-700 transition-colors duration-200">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Veure al mapa
                    </a>
                </div>
                <p id="modal-description" class="mt-4"></p>
            </div>
        </div>
    </div>

    <!-- Floating Filter Menu -->
    <div class="fixed bottom-8 right-8 z-40">
        <button id="toggle-filter-menu" class="bg-indigo-600 hover:bg-indigo-700 text-white p-4 rounded-full shadow-2xl transform transition duration-300 hover:scale-110 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-gray-900">
            <!-- Icona de filtre -->
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11h8"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15h2"></path>
            </svg>
        </button>

        <div id="floating-menu" class="absolute bottom-full right-0 w-64 bg-gray-800 p-4 rounded-lg shadow-xl mb-4 space-y-4 hidden">
            <h3 class="text-xl font-bold text-white mb-2">Filtres i ordenació</h3>
            
            <div>
                <p class="text-gray-400 mb-2">Tipus d'esdeveniment</p>
                <div class="flex flex-wrap gap-2">
                    <button class="filter-type-btn bg-gray-700 hover:bg-indigo-600 text-white text-xs px-3 py-1 rounded-full transition-colors duration-200" data-filter-type="all">Tots</button>
                    <button class="filter-type-btn bg-gray-700 hover:bg-indigo-600 text-white text-xs px-3 py-1 rounded-full transition-colors duration-200" data-filter-type="Swing">Swing</button>
                    <button class="filter-type-btn bg-gray-700 hover:bg-indigo-600 text-white text-xs px-3 py-1 rounded-full transition-colors duration-200" data-filter-type="Blues">Blues</button>
                    <button class="filter-type-btn bg-gray-700 hover:bg-indigo-600 text-white text-xs px-3 py-1 rounded-full transition-colors duration-200" data-filter-type="Revetlla">Balls de Revetlla</button>
                </div>
            </div>

            <div>
                <p class="text-gray-400 mb-2">Visibilitat d'esdeveniments</p>
                <div class="flex flex-wrap gap-2">
                    <button class="filter-mode-btn bg-gray-700 hover:bg-indigo-600 text-white text-xs px-3 py-1 rounded-full transition-colors duration-200" data-filter-mode="upcoming">Propers i Recents</button>
                    <button class="filter-mode-btn bg-gray-700 hover:bg-indigo-600 text-white text-xs px-3 py-1 rounded-full transition-colors duration-200" data-filter-mode="past">Esdeveniments Passats</button>
                </div>
            </div>

            <div>
                <p class="text-gray-400 mb-2">Ordenar per</p>
                <div class="flex gap-2">
                    <button class="sort-order-btn bg-gray-700 hover:bg-indigo-600 text-white text-xs px-3 py-1 rounded-full transition-colors duration-200" data-sort-order="date">Data</button>
                    <button class="sort-order-btn bg-gray-700 hover:bg-indigo-600 text-white text-xs px-3 py-1 rounded-full transition-colors duration-200" data-sort-order="proximity">Proximitat</button>
                </div>
            </div>
            
            <button id="show-map-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transform transition duration-300 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900">
                Veure Mapa
            </button>
            <p id="location-status" class="text-xs text-gray-500"></p>
        </div>
    </div>

    <!-- Map Modal -->
    <div id="map-modal" class="fixed inset-0 bg-black bg-opacity-90 flex flex-col items-center justify-center p-4 z-50 hidden">
        <button id="close-map-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white text-3xl font-bold transition-colors duration-200 z-[1001]">&times;</button>
        <div id="map" class="w-full h-full rounded-lg shadow-2xl"></div>
    </div>

    <!-- Leaflet JS for the map -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20n6+A4p3J55W8l7S9F6C/95W3E3w+d96yX2B1C6/nE="
     crossorigin=""></script>
    <script>
        // URL de la teva Google Sheet per a exportació en format CSV
        const sheetsUrl = 'https://docs.google.com/spreadsheets/d/1Wd5lL_NDmfvQ-SXIP74EN-gRXk3f5lizJdg3AHF2YpM/gviz/tq?tqx=out:csv&gid=0';

        let allEventsData = [];
        let userLocation = null;
        let currentFilterType = 'all';
        let currentSortOrder = 'date';
        let currentFilterMode = 'upcoming'; // 'upcoming' o 'past'
        let myMap = null;

        // Mapeig de tipus d'esdeveniments per als botons de filtre
        const eventTypeMapping = {
            'Swing': ['Swing Jam', 'Swing', 'Jam de swing', 'Jam de swing en format quartet'],
            'Blues': ['Jam Session de Blues Dance', 'Blues'],
            'Revetlla': ['Festa', 'Festa Major', 'revetlla']
        };

        // Coordenades geogràfiques de les ubicacions (simulades per a la demostració)
        const locationCoordinates = {
            "Club Marítim Altafulla": { lat: 41.1492, lon: 1.3857 },
            "Ajuntament de Constantí": { lat: 41.1770, lon: 1.2291 },
            "Picamoixons": { lat: 41.3129, lon: 1.3090 },
            "Garós": { lat: 42.7483, lon: 0.8874 },
            "Senan": { lat: 41.4429, lon: 1.1578 },
            "Av. del Mar, 1, 43520 L'Ametlla de Mar, Tarragona, España": { lat: 40.8653, lon: 0.7675 },
            "Av. de la Diputació s/n, Cambrils": { lat: 41.0772, lon: 1.0543 },
            "Carrer Masia, 3, 43520 Roquetes, Tarragona, España": { lat: 40.8037, lon: 0.5255 }
        };

        // Obtenció dels elements del DOM
        const eventsContainer = document.getElementById('events-container');
        const loadingMessage = document.getElementById('loading-message');
        const eventDetailModal = document.getElementById('event-detail-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const toggleFilterMenuBtn = document.getElementById('toggle-filter-menu');
        const floatingMenu = document.getElementById('floating-menu');
        const filterTypeButtons = document.querySelectorAll('.filter-type-btn');
        const sortOrderButtons = document.querySelectorAll('.sort-order-btn');
        const filterModeButtons = document.querySelectorAll('.filter-mode-btn');
        const locationStatus = document.getElementById('location-status');
        const showMapBtn = document.getElementById('show-map-btn');
        const mapModal = document.getElementById('map-modal');
        const closeMapBtn = document.getElementById('close-map-btn');

        const modalImage = document.getElementById('modal-image');
        const modalName = document.getElementById('modal-name');
        const modalDateTime = document.getElementById('modal-datetime');
        const modalLocation = document.getElementById('modal-location');
        const modalPrice = document.getElementById('modal-price');
        const modalType = document.getElementById('modal-type');
        const modalDescription = document.getElementById('modal-description');
        const modalMapLink = document.getElementById('modal-map-link');

        /**
         * Parses CSV text from the Google Sheet and converts it into a JSON array of objects.
         * @param {string} csv - The raw CSV text content.
         * @returns {Array<Object>} An array of event objects.
         */
        function parseCsvToJson(csv) {
            const data = [];
            const lines = csv.trim().split(/\r?\n/);
            if (lines.length <= 1) {
                console.error("CSV data has no events.");
                return data;
            }

            const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
            
            const regex = /("((?:[^"]|"")*)")|([^,]+)/g;
            
            let i = 1;
            while (i < lines.length) {
                let fullLine = lines[i];
                let numQuotes = (fullLine.match(/"/g) || []).length;
                
                // Si el nombre de cometes és senar, és un camp de diverses línies
                while (numQuotes % 2 !== 0 && i + 1 < lines.length) {
                    i++;
                    fullLine += '\n' + lines[i];
                    numQuotes = (fullLine.match(/"/g) || []).length;
                }
                
                const values = [];
                let match;
                while ((match = regex.exec(fullLine)) !== null) {
                    let value = match[2] !== undefined ? match[2] : match[3];
                    if (value === undefined) value = '';
                    values.push(value.replace(/""/g, '"').trim());
                }

                if (values.length === headers.length) {
                    const event = {};
                    headers.forEach((header, index) => {
                        let val = values[index] || '';
                        switch (header) {
                            case "Nom de l'esdeveniment": event.name = val; break;
                            case "Data i hora": event.dateTime = val; break;
                            case "Lloc": event.location = val; break;
                            case "Entrada": event.price = val; break;
                            case "Tipus": event.type = val; break;
                            case "url_imatge": event.imageUrl = val; break;
                            case "Descripció": event.description = val; break;
                            case "Data final": event.endDate = val; break;
                            case "Hora final": event.endTime = val; break;
                            case "Data inici": event.startDate = val; break;
                        }
                    });
                    data.push(event);
                } else {
                    console.error("Skipping malformed row:", fullLine);
                }
                i++;
            }
            return data;
        }

        /**
         * Fetches event data from Google Sheets and parses it.
         * @returns {Promise<Array<Object>>} A promise that resolves to an array of event objects.
         */
        async function fetchAndParseEvents() {
            try {
                const response = await fetch(sheetsUrl);
                const csvText = await response.text();
                return parseCsvToJson(csvText);
            } catch (error) {
                console.error("Error en carregar les dades de l'esdeveniment:", error);
                loadingMessage.textContent = 'Error en carregar les dades. Si us plau, intenta-ho de nou més tard.';
                return [];
            }
        }

        // Helper per obtenir el mes i el dia per a la capçalera i la targeta
        function getMonthAndDay(dateString) {
            if (!dateString) return {};
            const [day, month, year] = dateString.split('/');
            const monthNames = ["Gener", "Febrer", "Març", "Abril", "Maig", "Juny", "Juliol", "Agost", "Setembre", "Octubre", "Novembre", "Desembre"];
            const monthName = monthNames[parseInt(month, 10) - 1];
            return { day: parseInt(day, 10), monthName, year: parseInt(year, 10) };
        }
        
        /**
         * Checks if an event is in the past, based on its end date.
         * @param {Object} event - The event object.
         * @returns {boolean} True if the event has already ended, false otherwise.
         */
        function isEventPast(event) {
            if (!event.endDate || !event.endTime) return false;
            const [day, month, year] = event.endDate.split('/');
            const [hour, minute] = event.endTime.split(':');
            const eventDate = new Date(year, parseInt(month, 10) - 1, day, hour, minute);
            const now = new Date();
            return eventDate < now;
        }

        /**
         * Checks if an event is in the old past (more than 7 days ago).
         * @param {Object} event - The event object.
         * @returns {boolean} True if the event ended more than 7 days ago, false otherwise.
         */
        function isOldPastEvent(event) {
            if (!event.endDate || !event.endTime) return false;
            const [day, month, year] = event.endDate.split('/');
            const [hour, minute] = event.endTime.split(':');
            const eventDate = new Date(year, parseInt(month, 10) - 1, day, hour, minute);
            const now = new Date();
            
            const diffInMs = now.getTime() - eventDate.getTime();
            const sevenDaysInMs = 7 * 24 * 60 * 60 * 1000;
            
            return eventDate < now && diffInMs > sevenDaysInMs;
        }

        // Funció per generar un enllaç de Google Maps
        function generateGoogleMapsLink(location) {
            const baseUrl = 'https://www.google.com/maps/search/?api=1&query=';
            return baseUrl + encodeURIComponent(location);
        }

        // Funció per crear la targeta HTML d'un esdeveniment
        function createEventCard(event, day) {
            const cardWrapper = document.createElement('div');
            // Aplica la classe 'opacity-50' directament al contenidor principal si l'esdeveniment ja ha passat
            const isPast = isEventPast(event);
            const cardWrapperClasses = `flex items-center space-x-4 ${isPast ? 'opacity-50' : ''}`;
            cardWrapper.className = cardWrapperClasses;
            
            // Les classes de la targeta interior ja no necessiten la lògica d'opacitat
            const cardContentClasses = "bg-gray-800 rounded-lg shadow-lg p-4 cursor-pointer transform transition duration-300 hover:scale-105 hover:shadow-xl flex flex-grow items-center space-x-4";

            cardWrapper.innerHTML = `
                <div class="w-12 text-center flex-shrink-0">
                    <span class="bg-indigo-600 text-white font-bold py-2 px-3 rounded-full text-xl">${day}</span>
                </div>
                <div class="${cardContentClasses}">
                    <img
                        src="${event.imageUrl}"
                        alt="${event.name}"
                        class="w-24 h-24 rounded-full object-cover border-2 border-indigo-500 flex-shrink-0"
                        onerror="this.onerror=null;this.src='https://placehold.co/96x96/6366f1/ffffff?text=Event';"
                    />
                    <div class="flex-grow">
                        <h3 class="text-xl font-semibold text-white mb-1">${event.name}</h3>
                        <p class="text-indigo-300 text-sm">${event.dateTime}</p>
                        <p class="text-gray-400 text-sm">${event.location}</p>
                        <div class="flex items-center mt-2">
                            <span class="bg-indigo-600 text-white text-xs font-bold px-3 py-1 rounded-full mr-2">
                                ${event.price}
                            </span>
                            <span class="bg-gray-700 text-gray-300 text-xs font-medium px-3 py-1 rounded-full">
                                ${event.type}
                            </span>
                        </div>
                    </div>
                </div>
            `;
            // Add click listener programmatically
            cardWrapper.querySelector('div:last-child').addEventListener('click', () => {
                showEventDetail(event);
            });

            return cardWrapper;
        }

        // Funció per mostrar el modal de detalls de l'esdeveniment
        function showEventDetail(event) {
            modalImage.src = event.imageUrl;
            modalImage.alt = event.name;
            modalName.textContent = event.name;
            modalDateTime.textContent = event.dateTime;
            modalLocation.textContent = event.location;
            modalPrice.textContent = event.price;
            modalType.textContent = event.type;
            
            // Substituïm els salts de línia amb etiquetes <br> per a una correcta visualització.
            modalDescription.innerHTML = (event.description || '').replace(/(\r\n|\n)/g, '<br>');
            
            modalMapLink.href = generateGoogleMapsLink(event.location);
            eventDetailModal.classList.remove('hidden');
        }

        // Funció per amagar el modal
        function hideEventDetail() {
            eventDetailModal.classList.add('hidden');
        }
        
        /**
         * Initializes and displays the map with markers for all upcoming events.
         */
        function showMap() {
            mapModal.classList.remove('hidden');
            const mapContainer = document.getElementById('map');
            
            // Comprova si la llibreria Leaflet està disponible
            if (typeof L === 'undefined') {
                mapContainer.innerHTML = `<div class="p-4 text-center text-red-500">Error: La llibreria del mapa no s'ha pogut carregar. Si us plau, comprova la teva connexió a Internet.</div>`;
                return;
            }

            // Si el mapa ja està inicialitzat, només cal invalidar la seva mida
            if (myMap !== null) {
                 myMap.invalidateSize();
            } else {
                try {
                    // Inicialitza el mapa, centrat a Catalunya
                    myMap = L.map('map').setView([41.5, 1.7], 9);
                    
                    // Afegeix una capa base d'OpenStreetMap
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(myMap);
                } catch (error) {
                    console.error("Error al inicialitzar el mapa:", error);
                    mapContainer.innerHTML = `<div class="p-4 text-center text-red-500">
                        S'ha produït un error en carregar el mapa.
                        <br>Causa: ${error.message}
                        <br>Si us plau, torna-ho a intentar més tard o recarrega la pàgina.
                    </div>`;
                    return;
                }
            }

            // Afegeix marcadors per a tots els esdeveniments futurs
            allEventsData.forEach(event => {
                if (!isEventPast(event) && locationCoordinates[event.location]) {
                    const coords = locationCoordinates[event.location];
                    const marker = L.marker([coords.lat, coords.lon]).addTo(myMap);
                    marker.bindPopup(`<b>${event.name}</b><br>${event.location}`).openPopup();
                }
            });
            
            // Assegura que el mapa s'ajusti correctament a la mida del modal després que es mostri
            setTimeout(() => {
                myMap.invalidateSize();
            }, 100);

        }

        // Funció per amagar el modal del mapa
        function hideMap() {
            mapModal.classList.add('hidden');
        }

        // FUNCIÓ PER OBTENIR LA UBICACIÓ DE L'USUARI (si el navegador ho permet)
        function getUserLocation() {
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            userLocation = {
                                lat: position.coords.latitude,
                                lon: position.coords.longitude
                            };
                            locationStatus.textContent = 'Ubicació obtinguda!';
                            locationStatus.classList.remove('text-gray-500', 'text-red-500');
                            locationStatus.classList.add('text-green-500');
                            resolve(userLocation);
                        },
                        (error) => {
                            console.error("Error obtenint la ubicació:", error);
                            locationStatus.textContent = 'Error: Ubicació no disponible. Ordenant per data.';
                            locationStatus.classList.remove('text-gray-500', 'text-green-500');
                            locationStatus.classList.add('text-red-500');
                            userLocation = null;
                            resolve(null); // Resoldre amb null si hi ha un error
                        }
                    );
                } else {
                    locationStatus.textContent = 'Geolocation no és suportada pel teu navegador.';
                    locationStatus.classList.remove('text-gray-500', 'text-green-500');
                    locationStatus.classList.add('text-red-500');
                    resolve(null);
                }
            });
        }

        // FUNCIÓ PER CALCULAR LA DISTÀNCIA ENTRE DOS PUNTS (Fórmula de Haversine)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radi de la Terra en km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distància en km
        }

        // Funció per actualitzar l'estat dels botons de filtre
        function updateFilterButtons(type, order, mode) {
            filterTypeButtons.forEach(btn => {
                btn.classList.remove('bg-indigo-600');
                if (btn.dataset.filterType === type) {
                    btn.classList.add('bg-indigo-600');
                }
            });
            sortOrderButtons.forEach(btn => {
                btn.classList.remove('bg-indigo-600');
                if (btn.dataset.sortOrder === order) {
                    btn.classList.add('bg-indigo-600');
                }
            });
            filterModeButtons.forEach(btn => {
                 btn.classList.remove('bg-indigo-600');
                 if (btn.dataset.filterMode === mode) {
                     btn.classList.add('bg-indigo-600');
                 }
            });
        }
        
        // Funció principal per filtrar i renderitzar els esdeveniments
        async function renderEvents(initialFilter = 'all') {
            eventsContainer.innerHTML = '';
            
            let filteredEvents = allEventsData;
            
            // PRIMER FILTRE: PER VISIBILITAT (futurs/recents o passats antics)
            if (currentFilterMode === 'upcoming') {
                filteredEvents = filteredEvents.filter(event => !isOldPastEvent(event));
            } else if (currentFilterMode === 'past') {
                filteredEvents = filteredEvents.filter(event => isOldPastEvent(event));
            }

            // SEGON FILTRE: PER TIPUS (Swing, Blues, etc.)
            if (currentFilterType !== 'all') {
                const typesToFilter = eventTypeMapping[currentFilterType] || [];
                filteredEvents = filteredEvents.filter(event => {
                    const eventType = event.type || '';
                    return typesToFilter.some(type => eventType.includes(type));
                });
            } else {
                // Filtre principal (Agost/Setembre) només si no hi ha filtre de tipus
                if (initialFilter === 'august-september') {
                    filteredEvents = filteredEvents.filter(event => {
                        if (!event.startDate) return false;
                        const { monthName } = getMonthAndDay(event.startDate);
                        return monthName === 'Agost' || monthName === 'Setembre';
                    });
                }
            }

            // APLICAR L'ORDENACIÓ
            if (currentSortOrder === 'proximity' && userLocation) {
                // Ordenar per proximitat
                filteredEvents.sort((a, b) => {
                    const aCoords = locationCoordinates[a.location];
                    const bCoords = locationCoordinates[b.location];

                    if (!aCoords) return 1;
                    if (!bCoords) return -1;
                    
                    const distA = calculateDistance(userLocation.lat, userLocation.lon, aCoords.lat, aCoords.lon);
                    const distB = calculateDistance(userLocation.lat, userLocation.lon, bCoords.lat, bCoords.lon);
                    
                    a.distance = distA;
                    b.distance = distB;
                    
                    return distA - distB;
                });
            } else {
                // Ordenar per data (per defecte)
                filteredEvents.sort((a, b) => {
                    if (!a.startDate || !b.startDate) return 0;
                    const [d1, m1, y1] = a.startDate.split('/');
                    const [d2, m2, y2] = b.startDate.split('/');
                    return new Date(y1, m1 - 1, d1) - new Date(y2, m2 - 1, d2);
                });
            }

            // Agrupar els esdeveniments per mes o per proximitat
            if (currentSortOrder === 'proximity' && userLocation) {
                if (filteredEvents.length > 0) {
                     const proximityGroupDiv = document.createElement('div');
                     proximityGroupDiv.className = "mb-8";
                     proximityGroupDiv.innerHTML = `<h2 class="text-3xl sm:text-5xl font-extrabold text-white mb-6">Resultats per proximitat</h2>`;
                     filteredEvents.forEach(event => {
                        const { day } = getMonthAndDay(event.startDate);
                        const cardElement = createEventCard(event, day);
                        proximityGroupDiv.appendChild(cardElement);
                     });
                     eventsContainer.appendChild(proximityGroupDiv);
                }
            } else {
                const eventsGroupedByMonth = {};
                filteredEvents.forEach(event => {
                    if (!event.startDate) return;
                    const { day, monthName, year } = getMonthAndDay(event.startDate);
                    const monthYear = `${monthName} ${year}`;
                    if (!eventsGroupedByMonth[monthYear]) {
                        eventsGroupedByMonth[monthYear] = {};
                    }
                    if (!eventsGroupedByMonth[monthYear][day]) {
                        eventsGroupedByMonth[monthYear][day] = [];
                    }
                    eventsGroupedByMonth[monthYear][day].push(event);
                });

                const monthOrder = ["Juliol", "Agost", "Setembre"];
                const sortedMonths = Object.keys(eventsGroupedByMonth).sort((a, b) => {
                    const monthA = a.split(' ')[0];
                    const monthB = b.split(' ')[0];
                    const indexA = monthOrder.indexOf(monthA);
                    const indexB = monthOrder.indexOf(monthB);
                    return indexA - indexB;
                });
                
                sortedMonths.forEach(monthYear => {
                    const monthGroupDiv = document.createElement('div');
                    monthGroupDiv.className = "mb-8";
                    monthGroupDiv.innerHTML = `<h2 class="text-3xl sm:text-5xl font-extrabold text-white mb-6">${monthYear}</h2>`;

                    const sortedDays = Object.keys(eventsGroupedByMonth[monthYear]).sort((a, b) => parseInt(a) - parseInt(b));

                    sortedDays.forEach(day => {
                        eventsGroupedByMonth[monthYear][day].forEach(event => {
                            const cardElement = createEventCard(event, day);
                            monthGroupDiv.appendChild(cardElement);
                        });
                    });
                    eventsContainer.appendChild(monthGroupDiv);
                });
            }

            if (filteredEvents.length === 0) {
                eventsContainer.innerHTML = '<p class="text-center text-xl text-gray-400">No s\'han trobat esdeveniments.</p>';
            }
            updateFilterButtons(currentFilterType, currentSortOrder, currentFilterMode);
        }

        // LISTENERS D'ESDEVENIMENTS
        closeModalBtn.addEventListener('click', hideEventDetail);
        closeMapBtn.addEventListener('click', hideMap); // Listener per tancar el mapa
        
        // Listeners per al filtre flotant
        toggleFilterMenuBtn.addEventListener('click', () => {
            floatingMenu.classList.toggle('hidden');
        });

        filterTypeButtons.forEach(button => {
            button.addEventListener('click', () => {
                currentFilterType = button.dataset.filterType;
                renderEvents(); // Renderitza amb el nou filtre de tipus
            });
        });

        sortOrderButtons.forEach(button => {
            button.addEventListener('click', async () => {
                const newSortOrder = button.dataset.sortOrder;
                if (newSortOrder === 'proximity') {
                    if (!userLocation) {
                        locationStatus.textContent = 'Obtenint la teva ubicació...';
                        locationStatus.classList.remove('text-red-500', 'text-green-500');
                        locationStatus.classList.add('text-gray-500');
                        await getUserLocation(); // Espera a obtenir la ubicació
                        if (userLocation) {
                             currentSortOrder = newSortOrder;
                             renderEvents();
                        } else {
                            // Si no hi ha ubicació, tornem a l'ordenació per data
                            currentSortOrder = 'date';
                            renderEvents();
                        }
                    } else {
                         currentSortOrder = newSortOrder;
                         renderEvents();
                    }
                } else {
                    currentSortOrder = newSortOrder;
                    renderEvents();
                }
            });
        });
        
        filterModeButtons.forEach(button => {
            button.addEventListener('click', () => {
                currentFilterMode = button.dataset.filterMode;
                renderEvents();
            });
        });
        
        showMapBtn.addEventListener('click', showMap); // Listener per mostrar el mapa

        // Càrrega inicial de les dades i renderització
        async function init() {
            loadingMessage.classList.remove('hidden');
            allEventsData = await fetchAndParseEvents();
            loadingMessage.classList.add('hidden');
            // Intentar obtenir la ubicació de l'usuari a l'inici
            getUserLocation();
            renderEvents();
        }
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
