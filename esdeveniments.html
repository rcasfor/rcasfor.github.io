<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Esdeveniments d'Estiu</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom scrollbar for better aesthetics */
        .overflow-y-auto::-webkit-scrollbar {
            width: 8px;
        }
        .overflow-y-auto::-webkit-scrollbar-track {
            background: #2d3748; /* bg-gray-800 */
            border-radius: 10px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background: #6366f1; /* bg-indigo-600 */
            border-radius: 10px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background: #4f46e5; /* hover:bg-indigo-700 */
        }
    </style>
</head>
<body class="bg-gray-900 font-sans text-gray-100 p-4 sm:p-8">

    <div class="max-w-3xl mx-auto">
        <header class="flex items-center mb-8">
            <span class="text-indigo-400 text-4xl mr-4">&#x1F4C5;</span> <!-- Icona de calendari -->
            <h1 class="text-5xl font-extrabold text-white">Esdeveniments d'estiu</h1>
        </header>

        <div class="mb-8 flex space-x-4">
            <button id="show-all-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transform transition duration-300 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-gray-900">
                Tots els Esdeveniments
            </button>
            <button id="filter-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transform transition duration-300 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-gray-900">
                Agost i Setembre
            </button>
        </div>

        <div id="events-container" class="space-y-6">
            <p id="loading-message" class="text-center text-xl text-indigo-400 animate-pulse">Carregant esdeveniments...</p>
        </div>
    </div>

    <!-- Event Detail Modal -->
    <div id="event-detail-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-gray-900 rounded-lg shadow-2xl max-w-2xl w-full p-6 relative border border-indigo-700 max-h-[90vh] overflow-y-auto">
            <button id="close-modal-btn" class="absolute top-3 right-3 text-gray-400 hover:text-white text-2xl font-bold transition-colors duration-200">
                &times;
            </button>
            <img id="modal-image" src="" alt="" class="w-40 h-40 rounded-full object-cover mx-auto mb-6 border-4 border-indigo-500" onerror="this.onerror=null;this.src='https://placehold.co/160x160/6366f1/ffffff?text=Event';">
            <h2 id="modal-name" class="text-3xl font-extrabold text-white text-center mb-3"></h2>
            <p id="modal-datetime" class="text-indigo-400 text-lg text-center mb-4"></p>
            <div class="text-gray-300 space-y-3 pr-2">
                <p><strong>Lloc:</strong> <span id="modal-location"></span></p>
                <p><strong>Entrada:</strong> <span id="modal-price"></span></p>
                <p><strong>Tipus:</strong> <span id="modal-type"></span></p>
                <div class="mt-4">
                    <a id="modal-map-link" href="#" target="_blank" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white font-bold rounded-full shadow-lg hover:bg-blue-700 transition-colors duration-200">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Veure al mapa
                    </a>
                </div>
                <p id="modal-description" class="mt-4"></p>
            </div>
        </div>
    </div>

    <script>
        // URL de la teva Google Sheet per a exportació en format CSV
        const sheetsUrl = 'https://docs.google.com/spreadsheets/d/1Wd5lL_NDmfvQ-SXIP74EN-gRXk3f5lizJdg3AHF2YpM/gviz/tq?tqx=out:csv&gid=0';

        let allEventsData = [];

        // Obtenció dels elements del DOM
        const eventsContainer = document.getElementById('events-container');
        const loadingMessage = document.getElementById('loading-message');
        const eventDetailModal = document.getElementById('event-detail-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const showAllBtn = document.getElementById('show-all-btn');
        const filterBtn = document.getElementById('filter-btn');

        const modalImage = document.getElementById('modal-image');
        const modalName = document.getElementById('modal-name');
        const modalDateTime = document.getElementById('modal-datetime');
        const modalLocation = document.getElementById('modal-location');
        const modalPrice = document.getElementById('modal-price');
        const modalType = document.getElementById('modal-type');
        const modalDescription = document.getElementById('modal-description');
        const modalMapLink = document.getElementById('modal-map-link');

        /**
         * Parses CSV text from the Google Sheet and converts it into a JSON array of objects.
         * This version is more robust for multiline fields and commas within quotes.
         * @param {string} csv - The raw CSV text content.
         * @returns {Array<Object>} An array of event objects.
         */
        function parseCsvToJson(csv) {
            const data = [];
            const lines = csv.trim().split(/\r?\n/);
            if (lines.length <= 1) {
                console.error("CSV data has no events.");
                return data;
            }

            const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
            
            const regex = /("((?:[^"]|"")*)")|([^,]+)/g;
            
            let i = 1;
            while (i < lines.length) {
                let fullLine = lines[i];
                let numQuotes = (fullLine.match(/"/g) || []).length;
                
                // Si el nombre de cometes és senar, és un camp de diverses línies
                while (numQuotes % 2 !== 0 && i + 1 < lines.length) {
                    i++;
                    fullLine += '\n' + lines[i];
                    numQuotes = (fullLine.match(/"/g) || []).length;
                }
                
                const values = [];
                let match;
                while ((match = regex.exec(fullLine)) !== null) {
                    let value = match[2] !== undefined ? match[2] : match[3];
                    if (value === undefined) value = '';
                    values.push(value.replace(/""/g, '"').trim());
                }

                if (values.length === headers.length) {
                    const event = {};
                    headers.forEach((header, index) => {
                        let val = values[index] || '';
                        switch (header) {
                            case "Nom de l'esdeveniment": event.name = val; break;
                            case "Data i hora": event.dateTime = val; break;
                            case "Lloc": event.location = val; break;
                            case "Entrada": event.price = val; break;
                            case "Tipus": event.type = val; break;
                            case "url_imatge": event.imageUrl = val; break;
                            case "Descripció": event.description = val; break;
                            case "Data final": event.endDate = val; break;
                            case "Hora final": event.endTime = val; break;
                            case "Data inici": event.startDate = val; break;
                        }
                    });
                    data.push(event);
                } else {
                    console.error("Skipping malformed row:", fullLine);
                }
                i++;
            }
            return data;
        }

        /**
         * Fetches event data from Google Sheets and parses it.
         * @returns {Promise<Array<Object>>} A promise that resolves to an array of event objects.
         */
        async function fetchAndParseEvents() {
            try {
                const response = await fetch(sheetsUrl);
                const csvText = await response.text();
                return parseCsvToJson(csvText);
            } catch (error) {
                console.error("Error en carregar les dades de l'esdeveniment:", error);
                loadingMessage.textContent = 'Error en carregar les dades. Si us plau, intenta-ho de nou més tard.';
                return [];
            }
        }

        // Helper per obtenir el mes i el dia per a la capçalera i la targeta
        function getMonthAndDay(dateString) {
            if (!dateString) return {};
            const [day, month, year] = dateString.split('/');
            const monthNames = ["Gener", "Febrer", "Març", "Abril", "Maig", "Juny", "Juliol", "Agost", "Setembre", "Octubre", "Novembre", "Desembre"];
            const monthName = monthNames[parseInt(month, 10) - 1];
            return { day: parseInt(day, 10), monthName, year: parseInt(year, 10) };
        }
        
        // Funció per comprovar si un esdeveniment ja ha passat, utilitzant la data i hora final
        function isPastEvent(event) {
            if (!event.endDate || !event.endTime) return false;
            const [day, month, year] = event.endDate.split('/');
            const [hour, minute] = event.endTime.split(':');
            const eventDate = new Date(year, parseInt(month, 10) - 1, day, hour, minute);
            const now = new Date();
            return eventDate < now;
        }

        // Funció per generar un enllaç de Google Maps
        function generateGoogleMapsLink(location) {
            const baseUrl = 'https://www.google.com/maps/search/?api=1&query=';
            return baseUrl + encodeURIComponent(location);
        }

        // Funció per crear la targeta HTML d'un esdeveniment
        function createEventCard(event, day) {
            const cardWrapper = document.createElement('div');
            cardWrapper.className = 'flex items-center space-x-4';

            const isPast = isPastEvent(event);
            const cardClasses = isPast
                ? "bg-gray-800 rounded-lg shadow-lg p-4 flex flex-grow items-center space-x-4 opacity-50 transform scale-95"
                : "bg-gray-800 rounded-lg shadow-lg p-4 cursor-pointer transform transition duration-300 hover:scale-105 hover:shadow-xl flex flex-grow items-center space-x-4 event-card";

            cardWrapper.innerHTML = `
                <div class="w-12 text-center flex-shrink-0">
                    <span class="bg-indigo-600 text-white font-bold py-2 px-3 rounded-full text-xl">${day}</span>
                </div>
                <div class="${cardClasses}">
                    <img
                        src="${event.imageUrl}"
                        alt="${event.name}"
                        class="w-24 h-24 rounded-full object-cover border-2 border-indigo-500 flex-shrink-0"
                        onerror="this.onerror=null;this.src='https://placehold.co/96x96/6366f1/ffffff?text=Event';"
                    />
                    <div class="flex-grow">
                        <h3 class="text-xl font-semibold text-white mb-1">${event.name}</h3>
                        <p class="text-indigo-300 text-sm">${event.dateTime}</p>
                        <p class="text-gray-400 text-sm">${event.location}</p>
                        <div class="flex items-center mt-2">
                            <span class="bg-indigo-600 text-white text-xs font-bold px-3 py-1 rounded-full mr-2">
                                ${event.price}
                            </span>
                            <span class="bg-gray-700 text-gray-300 text-xs font-medium px-3 py-1 rounded-full">
                                ${event.type}
                            </span>
                        </div>
                    </div>
                </div>
            `;
            // Afegeix el listener de clic només si l'esdeveniment no ha passat
            if (!isPast) {
                cardWrapper.querySelector('.event-card').addEventListener('click', () => {
                    showEventDetail(event);
                });
            }

            return cardWrapper;
        }

        // Funció per mostrar el modal de detalls de l'esdeveniment
        function showEventDetail(event) {
            modalImage.src = event.imageUrl;
            modalImage.alt = event.name;
            modalName.textContent = event.name;
            modalDateTime.textContent = event.dateTime;
            modalLocation.textContent = event.location;
            modalPrice.textContent = event.price;
            modalType.textContent = event.type;
            
            // Substituïm els salts de línia amb etiquetes <br> per a una correcta visualització.
            modalDescription.innerHTML = (event.description || '').replace(/(\r\n|\n)/g, '<br>');
            
            modalMapLink.href = generateGoogleMapsLink(event.location);
            eventDetailModal.classList.remove('hidden');
        }

        // Funció per amagar el modal
        function hideEventDetail() {
            eventDetailModal.classList.add('hidden');
        }

        // Funció principal per filtrar i renderitzar els esdeveniments
        function renderEvents(filter = 'all') {
            eventsContainer.innerHTML = '';
            
            let filteredEvents = allEventsData;
            if (filter === 'august-september') {
                filteredEvents = allEventsData.filter(event => {
                    if (!event.startDate) return false;
                    const { monthName } = getMonthAndDay(event.startDate);
                    return monthName === 'Agost' || monthName === 'Setembre';
                });
            }

            // Ordenar esdeveniments per data d'inici
            filteredEvents.sort((a, b) => {
                if (!a.startDate || !b.startDate) return 0;
                const [d1, m1, y1] = a.startDate.split('/');
                const [d2, m2, y2] = b.startDate.split('/');
                return new Date(y1, m1 - 1, d1) - new Date(y2, m2 - 1, d2);
            });

            // Agrupar els esdeveniments per mes
            const eventsGroupedByMonth = {};
            filteredEvents.forEach(event => {
                if (!event.startDate) return;
                const { day, monthName, year } = getMonthAndDay(event.startDate);
                const monthYear = `${monthName} ${year}`;
                if (!eventsGroupedByMonth[monthYear]) {
                    eventsGroupedByMonth[monthYear] = {};
                }
                if (!eventsGroupedByMonth[monthYear][day]) {
                    eventsGroupedByMonth[monthYear][day] = [];
                }
                eventsGroupedByMonth[monthYear][day].push(event);
            });

            const monthOrder = ["Juliol", "Agost", "Setembre"];
            const sortedMonths = Object.keys(eventsGroupedByMonth).sort((a, b) => {
                const monthA = a.split(' ')[0];
                const monthB = b.split(' ')[0];
                const indexA = monthOrder.indexOf(monthA);
                const indexB = monthOrder.indexOf(monthB);
                return indexA - indexB;
            });
            
            sortedMonths.forEach(monthYear => {
                const monthGroupDiv = document.createElement('div');
                monthGroupDiv.className = "mb-8";
                monthGroupDiv.innerHTML = `<h2 class="text-3xl sm:text-5xl font-extrabold text-white mb-6">${monthYear}</h2>`;

                const sortedDays = Object.keys(eventsGroupedByMonth[monthYear]).sort((a, b) => parseInt(a) - parseInt(b));

                sortedDays.forEach(day => {
                    eventsGroupedByMonth[monthYear][day].forEach(event => {
                        const cardElement = createEventCard(event, day);
                        monthGroupDiv.appendChild(cardElement);
                    });
                });
                eventsContainer.appendChild(monthGroupDiv);
            });
            
            if (filteredEvents.length === 0) {
                eventsContainer.innerHTML = '<p class="text-center text-xl text-gray-400">No s\'han trobat esdeveniments.</p>';
            }
        }

        // Listeners d'esdeveniments
        closeModalBtn.addEventListener('click', hideEventDetail);
        showAllBtn.addEventListener('click', () => renderEvents('all'));
        filterBtn.addEventListener('click', () => renderEvents('august-september'));
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !eventDetailModal.classList.contains('hidden')) {
                hideEventDetail();
            }
        });

        // Càrrega inicial de les dades i renderització
        async function init() {
            loadingMessage.classList.remove('hidden');
            allEventsData = await fetchAndParseEvents();
            loadingMessage.classList.add('hidden');
            renderEvents('all');
        }
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
