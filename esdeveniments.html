<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Esdeveniments d'Estiu</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom scrollbar for better aesthetics */
        .overflow-y-auto::-webkit-scrollbar {
            width: 8px;
        }
        .overflow-y-auto::-webkit-scrollbar-track {
            background: #2d3748; /* bg-gray-800 */
            border-radius: 10px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background: #6366f1; /* bg-indigo-600 */
            border-radius: 10px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background: #4f46e5; /* hover:bg-indigo-700 */
        }

        /* Leaflet Map styles */
        #map {
            height: 100%;
            width: 100%;
            border-radius: 0.5rem;
        }
    </style>
    <!-- Leaflet CSS for the map -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"
     xintegrity="sha512-ZIGSXXl7C9jE16gY6c4jI58d8gP4sF2g9J8t8F2o6o30LqE6d5t5u5e3q5b6w2s3A6p6f6p6f6p6p6o2b5w=="
     crossorigin=""></script>

    <!-- Open Graph Meta Tags for social media sharing snippets -->
    <meta property="og:title" content="Esdeveniments d'Estiu">
    <meta property="og:description" content="Descobreix els millors esdeveniments de swing, blues i revetlles d'estiu a la teva zona.">
    <meta property="og:image" content="https://rcasfor.github.io/logo%20esdeveniments.png"> <!-- Replace with your actual image URL -->
    <meta property="og:url" content="https://rcasfor.github.io/esdeveniments.html"> <!-- Replace with the actual URL of your page -->
    <meta property="og:type" content="website">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
</head>
<body class="bg-gray-900 font-sans text-gray-100 p-4 sm:p-8">

    <div class="max-w-3xl mx-auto">
        <header class="flex items-center mb-8">
            <!-- Logotip proporcionat per l'usuari -->
            <img src="https://rcasfor.github.io/logo%20esdeveniments.png" alt="Logotip Esdeveniments d'Estiu" class="w-16 h-16 mr-4 rounded-full object-cover">
            <h1 class="text-5xl font-extrabold text-white">Esdeveniments d'estiu</h1>
        </header>

        <!-- Collapsible Filter Header -->
        <div id="filter-header" class="sticky top-0 bg-gray-800 p-4 rounded-lg shadow-xl mb-8 z-30">
            <div class="flex justify-between items-center cursor-pointer" id="toggle-filter-header">
                <h3 class="text-xl font-bold text-white">Filtres i ordenació</h3>
                <svg id="filter-chevron" class="w-6 h-6 text-white transform transition-transform duration-300 rotate-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </div>
            <div id="filter-content" class="mt-4 space-y-4 hidden">
                <div>
                    <p class="text-gray-400 mb-2">Tipus d'esdeveniment</p>
                    <div class="flex flex-wrap gap-2">
                        <button class="filter-type-btn bg-gray-700 hover:bg-indigo-600 text-white text-xs px-3 py-1 rounded-full transition-colors duration-200" data-filter-type="all">Tots</button>
                        <button class="filter-type-btn bg-gray-700 hover:bg-indigo-600 text-white text-xs px-3 py-1 rounded-full transition-colors duration-200" data-filter-type="Swing">Swing</button>
                        <button class="filter-type-btn bg-gray-700 hover:bg-indigo-600 text-white text-xs px-3 py-1 rounded-full transition-colors duration-200" data-filter-type="Blues">Blues</button>
                        <button class="filter-type-btn bg-gray-700 hover:bg-indigo-600 text-white text-xs px-3 py-1 rounded-full transition-colors duration-200" data-filter-type="Revetlla">Balls de Revetlla</button>
                    </div>
                </div>

                <div>
                    <p class="text-gray-400 mb-2">Visibilitat d'esdeveniments</p>
                    <div class="flex flex-wrap gap-2">
                        <button class="filter-mode-btn bg-gray-700 hover:bg-indigo-600 text-white text-xs px-3 py-1 rounded-full transition-colors duration-200" data-filter-mode="upcoming">Propers i Recents</button>
                        <button class="filter-mode-btn bg-gray-700 hover:bg-indigo-600 text-white text-xs px-3 py-1 rounded-full transition-colors duration-200" data-filter-mode="past">Esdeveniments Passats</button>
                    </div>
                </div>

                <div>
                    <p class="text-gray-400 mb-2">Ordenar per</p>
                    <div class="flex gap-2">
                        <button class="sort-order-btn bg-gray-700 hover:bg-indigo-600 text-white text-xs px-3 py-1 rounded-full transition-colors duration-200" data-sort-order="date">Data</button>
                        <button class="sort-order-btn bg-gray-700 hover:bg-indigo-600 text-white text-xs px-3 py-1 rounded-full transition-colors duration-200" data-sort-order="proximity">Proximitat</button>
                    </div>
                </div>
                
                <button id="show-map-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transform transition duration-300 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900">
                    Veure Mapa
                </button>
                <p id="status-message" class="text-xs text-gray-500"></p>
            </div>
        </div>

        <div id="events-container" class="space-y-6">
            <p id="loading-message" class="text-center text-xl text-indigo-400 animate-pulse">Carregant esdeveniments...</p>
        </div>
    </div>

    <!-- Event Detail Modal -->
    <div id="event-detail-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-gray-900 rounded-lg shadow-2xl max-w-2xl w-full p-6 relative border border-indigo-700 max-h-[90vh] overflow-y-auto">
            <button id="close-modal-btn" class="absolute top-3 right-3 text-gray-400 hover:text-white text-2xl font-bold transition-colors duration-200">
                &times;
            </button>
            <!-- Enllaç per obrir la imatge a mida completa -->
            <a id="modal-image-link" href="#" target="_blank" class="block">
                <img id="modal-image" src="" alt="" class="w-full h-auto rounded-lg object-cover mb-6 border-4 border-indigo-500" onerror="this.onerror=null;this.src='https://placehold.co/160x160/6366f1/ffffff?text=Event';">
            </a>
            <h2 id="modal-name" class="text-3xl font-extrabold text-white text-center mb-3"></h2>
            <p id="modal-datetime" class="text-indigo-400 text-lg text-center mb-4"></p>
            <div class="text-gray-300 space-y-3 pr-2">
                <p><strong>Lloc:</strong> <span id="modal-location"></span></p>
                <p><strong>Entrada:</strong> <span id="modal-price"></span></p>
                <p><strong>Tipus:</strong> <span id="modal-type"></span></p>
                <!-- New field for Organizer -->
                <p id="modal-organizer-row" class="hidden">
                    <strong>Organitzador:</strong> <span id="modal-organizer"></span>
                </p>
                <!-- New section for registration URL -->
                <p id="modal-tickets-row" class="hidden">
                    <strong>Inscripció:</strong> <a id="modal-tickets-url" href="#" target="_blank" class="text-blue-400 hover:text-blue-300 underline"></a>
                </p>
                <div class="flex items-center justify-between mt-4">
                    <a id="modal-map-link" href="#" target="_blank" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white font-bold rounded-full shadow-lg hover:bg-blue-700 transition-colors duration-200">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Veure al mapa
                    </a>
                    <button id="share-event-btn" class="inline-flex items-center px-4 py-2 bg-gray-700 text-white font-bold rounded-full shadow-lg hover:bg-gray-600 transition-colors duration-200">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.882 14.28 9.392 15 10.38 15h3.14c1.243 0 1.966-.883 2.112-1.686m-5.46-3.874a1.867 1.867 0 010-3.733m0 3.733v-3.733m-2.112 1.867h4.224m-4.224 0a1.867 1.867 0 010-3.733m0 3.733v-3.733"></path>
                        </svg>
                        Compartir
                    </button>
                </div>
                <p id="modal-description" class="mt-4"></p>
                <!-- Share confirmation message -->
                <p id="share-confirmation-message" class="text-center text-sm mt-4 text-green-500 hidden">Enllaç copiat al porta-retalls!</p>
            </div>
        </div>
    </div>

    <!-- Map Modal -->
    <div id="map-modal" class="fixed inset-0 bg-black bg-opacity-90 flex flex-col items-center justify-center p-4 z-50 hidden">
        <button id="close-map-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white text-3xl font-bold transition-colors duration-200 z-[1001]">&times;</button>
        <div id="map" class="w-full h-full rounded-lg shadow-2xl"></div>
    </div>

    <!-- Leaflet JS for the map -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"
     xintegrity="sha512-ZIGSXXl7C9jE16gY6c4jI58d8gP4sF2g9J8t8F2o6o30LqE6d5t5u5e3q5b6w2s3A6p6f6p6f6p6p6o2b5w=="
     crossorigin=""></script>
    <script>
        // URL de la teva Google Sheet per a exportació en format CSV
        const sheetsUrl = 'https://docs.google.com/spreadsheets/d/1Wd5lL_NDmfvQ-SXIP74EN-gRXk3f5lizJdg3AHF2YpM/gviz/tq?tqx=out:csv&gid=0';

        // API Key d'OpenCage
        const openCageApiKey = '9932c1b4ea9e482e8d04d7c96ca535d2';
        
        let allEventsData = [];
        let userLocation = null;
        let currentFilterType = 'all';
        let currentSortOrder = 'date';
        let currentFilterMode = 'upcoming'; // 'upcoming' o 'past'
        let myMap = null;

        // Mapeig de tipus d'esdeveniments per als botons de filtre
        const eventTypeMapping = {
            'Swing': ['Swing Jam', 'Swing', 'Jam de swing'],
            'Blues': ['Jam Session de Blues Dance', 'Blues'],
            'Revetlla': ['Festa', 'Festa Major', 'revetlla']
        };
        
        // Objecte per emmagatzemar les coordenades geocodificades de les ubicacions
        let locationCoordinates = {};
        
        // Per mantenir un seguiment de l'esdeveniment obert per a la funció de compartir
        let activeEvent = null;

        // Obtenció dels elements del DOM
        const eventsContainer = document.getElementById('events-container');
        const loadingMessage = document.getElementById('loading-message');
        const eventDetailModal = document.getElementById('event-detail-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const filterHeader = document.getElementById('filter-header');
        const toggleFilterHeaderBtn = document.getElementById('toggle-filter-header');
        const filterContent = document.getElementById('filter-content');
        const filterChevron = document.getElementById('filter-chevron');

        const filterTypeButtons = document.querySelectorAll('.filter-type-btn');
        const sortOrderButtons = document.querySelectorAll('.sort-order-btn');
        const filterModeButtons = document.querySelectorAll('.filter-mode-btn');
        const statusMessageElement = document.getElementById('status-message');
        const showMapBtn = document.getElementById('show-map-btn');
        const mapModal = document.getElementById('map-modal');
        const closeMapBtn = document.getElementById('close-map-btn');

        const modalImage = document.getElementById('modal-image');
        const modalImageLink = document.getElementById('modal-image-link');
        const modalName = document.getElementById('modal-name');
        const modalDateTime = document.getElementById('modal-datetime');
        const modalLocation = document.getElementById('modal-location');
        const modalPrice = document.getElementById('modal-price');
        const modalType = document.getElementById('modal-type');
        const modalDescription = document.getElementById('modal-description');
        const modalMapLink = document.getElementById('modal-map-link');
        const modalTicketsRow = document.getElementById('modal-tickets-row');
        const modalTicketsUrl = document.getElementById('modal-tickets-url');
        const modalOrganizerRow = document.getElementById('modal-organizer-row');
        const modalOrganizer = document.getElementById('modal-organizer');
        const shareConfirmationMessage = document.getElementById('share-confirmation-message');

        /**
         * Funció per normalitzar cadenes de text per a que la cerca sigui més fiable.
         * @param {string} str - La cadena a normalitzar.
         * @returns {string} La cadena normalitzada.
         */
        function normalizeString(str) {
            if (!str) return '';
            // Retorna la cadena sense modificar, ja que la coincidència ha de ser exacta amb les claus de l'objecte
            return str.trim();
        }
        
        /**
         * Funció per mostrar missatges d'estat a l'usuari.
         * @param {string} message - El missatge a mostrar.
         * @param {string} type - El tipus de missatge ('info', 'success', 'error').
         */
        function logStatus(message, type = 'info') {
            statusMessageElement.textContent = message;
            statusMessageElement.classList.remove('text-gray-500', 'text-green-500', 'text-red-500');
            if (type === 'success') {
                statusMessageElement.classList.add('text-green-500');
            } else if (type === 'error') {
                statusMessageElement.classList.add('text-red-500');
            } else {
                statusMessageElement.classList.add('text-gray-500');
            }
        }

        /**
         * Parses CSV text from the Google Sheet and converts it into a JSON array of objects.
         * @param {string} csv - The raw CSV text content.
         * @returns {Array<Object>} An array of event objects.
         */
        function parseCsvToJson(csv) {
            const data = [];
            const lines = csv.trim().split(/\r?\n/);
            if (lines.length <= 1) {
                console.error("CSV data has no events.");
                return data;
            }

            const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
            
            const regex = /("((?:[^"]|"")*)")|([^,]+)/g;
            
            let i = 1;
            while (i < lines.length) {
                let fullLine = lines[i];
                let numQuotes = (fullLine.match(/"/g) || []).length;
                
                // Si el nombre de cometes és senar, és un camp de diverses línies
                while (numQuotes % 2 !== 0 && i + 1 < lines.length) {
                    i++;
                    fullLine += '\n' + lines[i];
                    numQuotes = (fullLine.match(/"/g) || []).length;
                }
                
                const values = [];
                let match;
                while ((match = regex.exec(fullLine)) !== null) {
                    let value = match[2] !== undefined ? match[2] : match[3];
                    if (value === undefined) value = '';
                    values.push(value.replace(/""/g, '"').trim());
                }

                if (values.length === headers.length) {
                    const event = {};
                    headers.forEach((header, index) => {
                        let val = values[index] || '';
                        switch (header) {
                            case "Nom de l'esdeveniment": event.name = val; break;
                            case "Data i hora": event.dateTime = val; break;
                            case "Data inici": event.startDate = val; break;
                            case "Hora inici": event.startTime = val; break;
                            case "Data final": event.endDate = val; break;
                            case "Hora final": event.endTime = val; break;
                            case "Lloc": event.location = val; break;
                            case "Entrada": event.price = val; break;
                            case "Tipus": event.type = val; break;
                            case "url_imatge": event.imageUrl = val; break;
                            case "Descripció": event.description = val; break;
                            case "Url_entrades": event.ticketsUrl = val; break;
                            case "Organitza": event.organizer = val; break; // New field
                        }
                    });
                    data.push(event);
                } else {
                    console.error("Skipping malformed row:", fullLine);
                }
                i++;
            }
            return data;
        }

        /**
         * Fetches event data from Google Sheets and parses it.
         * @returns {Promise<Array<Object>>} A promise that resolves to an array of event objects.
         */
        async function fetchAndParseEvents() {
            try {
                const response = await fetch(sheetsUrl);
                const csvText = await response.text();
                return parseCsvToJson(csvText);
            } catch (error) {
                console.error("Error en carregar les dades de l'esdeveniment:", error);
                loadingMessage.textContent = 'Error en carregar les dades. Si us plau, intenta-ho de nou més tard.';
                return [];
            }
        }

        /**
         * Funció per geocodificar una adreça utilitzant l'API d'OpenCage.
         * @param {string} address - L'adreça a geocodificar.
         * @returns {Promise<Object|null>} Un objecte amb latitud i longitud o null si no es troba.
         */
        async function geocodeAddress(address) {
            if (!openCageApiKey || !address) {
                console.warn('API Key or address missing for geocoding.');
                return null;
            }
            const encodedAddress = encodeURIComponent(address);
            const url = `https://api.opencagedata.com/geocode/v1/json?q=${encodedAddress}&key=${openCageApiKey}&language=ca&pretty=1`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.results && data.results.length > 0) {
                    const { lat, lng } = data.results[0].geometry;
                    return { lat, lon: lng };
                } else {
                    console.warn(`No s'han trobat coordenades per a l'adreça: ${address}`);
                    return null;
                }
            } catch (error) {
                console.error('Error en la geocodificació:', error);
                return null;
            }
        }

        // Helper per obtenir el mes i el dia per a la capçalera i la targeta
        function getMonthAndDay(dateString) {
            if (!dateString) return {};
            const [day, month, year] = dateString.split('/');
            const monthNames = ["Gener", "Febrer", "Març", "Abril", "Maig", "Juny", "Juliol", "Agost", "Setembre", "Octubre", "Novembre", "Desembre"];
            const monthName = monthNames[parseInt(month, 10) - 1];
            return { day: parseInt(day, 10), monthName, year: parseInt(year, 10) };
        }
        
        /**
         * Checks if an event is in the past, based on its end date.
         * @param {Object} event - The event object.
         * @returns {boolean} True if the event has already ended, false otherwise.
         */
        function isEventPast(event) {
            if (!event.endDate || !event.endTime) return false;
            const [day, month, year] = event.endDate.split('/');
            const [hour, minute] = event.endTime.split(':');
            const eventDate = new Date(year, parseInt(month, 10) - 1, day, hour, minute);
            const now = new Date();
            return eventDate < now;
        }

        /**
         * Checks if an event is in the old past (more than 7 days ago).
         * @param {Object} event - The event object.
         * @returns {boolean} True if the event ended more than 7 days ago, false otherwise.
         */
        function isOldPastEvent(event) {
            if (!event.endDate || !event.endTime) return false;
            const [day, month, year] = event.endDate.split('/');
            const [hour, minute] = event.endTime.split(':');
            const eventDate = new Date(year, parseInt(month, 10) - 1, day, hour, minute);
            const now = new Date();
            
            const diffInMs = now.getTime() - eventDate.getTime();
            const sevenDaysInMs = 3 * 24 * 60 * 60 * 1000;
            
            return eventDate < now && diffInMs > sevenDaysInMs;
        }

        // Funció per generar un enllaç de Google Maps
        function generateGoogleMapsLink(location) {
            const baseUrl = 'https://www.google.com/maps/search/?api=1&query=';
            return baseUrl + encodeURIComponent(location);
        }

        // Funció per crear la targeta HTML d'un esdeveniment
        function createEventCard(event, day) {
            const cardWrapper = document.createElement('div');
            // Aplica la classe 'opacity-50' directament al contenidor principal si l'esdeveniment ja ha passat
            const isPast = isEventPast(event);
            const cardWrapperClasses = `flex items-center space-x-4 ${isPast ? 'opacity-50' : ''}`;
            cardWrapper.className = cardWrapperClasses;
            
            // Les classes de la targeta interior ja no necessiten la lògica d'opacitat
            const cardContentClasses = "bg-gray-800 rounded-lg shadow-lg p-4 cursor-pointer transform transition duration-300 hover:scale-105 hover:shadow-xl flex flex-grow items-center space-x-4";

            // Add distance display if available
            const distanceHtml = event.distance !== undefined ? 
                `<p class="text-gray-400 text-sm mt-1">Distància: ${event.distance.toFixed(2)} km</p>` : '';

            cardWrapper.innerHTML = `
                <div class="w-12 text-center flex-shrink-0">
                    <span class="bg-indigo-600 text-white font-bold py-2 px-3 rounded-full text-xl">${day}</span>
                </div>
                <div class="${cardContentClasses}">
                    <img
                        src="${event.imageUrl}"
                        alt="${event.name}"
                        class="w-24 h-24 rounded-full object-cover border-2 border-indigo-500 flex-shrink-0"
                        onerror="this.onerror=null;this.src='https://placehold.co/96x96/6366f1/ffffff?text=Event';">
                    <div class="flex-grow">
                        <h3 class="text-xl font-semibold text-white mb-1">${event.name}</h3>
                        <p class="text-indigo-300 text-sm">${event.dateTime}</p>
                        <p class="text-gray-400 text-sm">${event.location}</p>
                        ${distanceHtml} <!-- Insert distance here -->
                        <div class="flex items-center mt-2">
                            <span class="bg-indigo-600 text-white text-xs font-bold px-3 py-1 rounded-full mr-2">
                                ${event.price}
                            </span>
                            <span class="bg-gray-700 text-gray-300 text-xs font-medium px-3 py-1 rounded-full">
                                ${event.type}
                            </span>
                        </div>
                    </div>
                </div>
            `;
            // Add click listener programmatically
            cardWrapper.querySelector('div:last-child').addEventListener('click', () => {
                showEventDetail(event);
            });

            return cardWrapper;
        }

        // Funció per mostrar el modal de detalls de l'esdeveniment
        function showEventDetail(event) {
            activeEvent = event;
            // Set URL hash for sharing
            window.location.hash = `event-${normalizeString(event.name).replace(/\s+/g, '-')}`;

            modalImage.src = event.imageUrl;
            modalImage.alt = event.name;
            // Set the href of the link to the image URL
            if (modalImageLink) {
                modalImageLink.href = event.imageUrl;
            }
            modalName.textContent = event.name;
            modalDateTime.textContent = event.dateTime;
            modalLocation.textContent = event.location;
            modalPrice.textContent = event.price;
            modalType.textContent = event.type;
            
            // Substituïm els salts de línia amb etiquetes <br> per a una correcta visualització.
            modalDescription.innerHTML = (event.description || '').replace(/(\r\n|\n)/g, '<br>');
            
            modalMapLink.href = generateGoogleMapsLink(event.location);

            // Handle organizer field
            if (event.organizer && event.organizer.trim() !== '') {
                modalOrganizer.textContent = event.organizer;
                modalOrganizerRow.classList.remove('hidden');
            } else {
                modalOrganizerRow.classList.add('hidden');
            }

            // Handle tickets URL
            if (event.ticketsUrl && event.ticketsUrl.trim() !== '') {
                modalTicketsUrl.href = event.ticketsUrl;
                modalTicketsUrl.textContent = event.ticketsUrl;
                modalTicketsRow.classList.remove('hidden');
            } else {
                modalTicketsRow.classList.add('hidden');
            }

            eventDetailModal.classList.remove('hidden');
        }

        // Funció per amagar el modal
        function hideEventDetail() {
            eventDetailModal.classList.add('hidden');
            window.location.hash = ''; // Clear the hash
            activeEvent = null;
        }

        /**
         * Funció per compartir l'enllaç de l'esdeveniment actiu.
         */
        function shareEvent() {
            if (!activeEvent) return;

            const eventNameSlug = normalizeString(activeEvent.name).replace(/\s+/g, '-');
            const shareUrl = `https://rcasfor.github.io/esdeveniments.html#event-${eventNameSlug}`;
            
            // Use the fallback method which is compatible with all browsers in this type of environment
            const textArea = document.createElement('textarea');
            textArea.value = shareUrl;
            document.body.appendChild(textArea);
            textArea.select();

            try {
                document.execCommand('copy');
                // Show confirmation message
                shareConfirmationMessage.classList.remove('hidden');
                setTimeout(() => {
                    shareConfirmationMessage.classList.add('hidden');
                }, 3000);
            } catch (err) {
                console.error('No s\'ha pogut copiar l\'enllaç:', err);
                logStatus('Error: No s\'ha pogut copiar l\'enllaç.', 'error');
            } finally {
                document.body.removeChild(textArea);
            }
        }
        
        // Listener for share button
        document.getElementById('share-event-btn').addEventListener('click', shareEvent);

        /**
         * Initializes and displays the map with markers for all upcoming events.
         */
        function showMap() {
            const mapContainer = document.getElementById('map');
            mapModal.classList.remove('hidden');

            // Neteja qualsevol contingut d'error anterior
            mapContainer.innerHTML = '';
            
            // Comprova si la llibreria Leaflet està disponible
            if (typeof L === 'undefined') {
                mapContainer.innerHTML = `<div class="p-4 text-center text-red-500">
                    Error greu: La llibreria del mapa (Leaflet) no s'ha pogut carregar.
                    <br>Això pot ser degut a una connexió a Internet inestable o a un problema amb els scripts externs.
                    <br>Si us plau, recarrega la pàgina.
                </div>`;
                return;
            }

            // Si el mapa ja està inicialitzat, només cal invalidar la seva mida per redimensionar-lo
            if (myMap !== null) {
                myMap.invalidateSize();
            } else {
                try {
                    // Inicialitza el mapa, centrat a Catalunya
                    myMap = L.map('map').setView([41.5, 1.7], 9);
                    
                    // Afegeix una capa base d'OpenStreetMap
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(myMap);
                } catch (error) {
                    console.error("Error al inicialitzar el mapa:", error);
                    mapContainer.innerHTML = `<div class="p-4 text-center text-red-500">
                        S'ha produït un error en carregar el mapa.
                        <br>Causa: ${error.message}
                        <br>Si us plau, torna-ho a intentar més tard o recarrega la pàgina.
                    </div>`;
                    return;
                }
            }
            
            const markers = [];
            
            // Agrupa els esdeveniments per ubicació, utilitzant les coordenades de l'objecte global
            const eventsByLocation = {};
            allEventsData.forEach(event => {
                const normalizedLocation = event.location;
                if (!isEventPast(event) && locationCoordinates[normalizedLocation]) {
                    if (!eventsByLocation[normalizedLocation]) {
                        eventsByLocation[normalizedLocation] = [];
                    }
                    eventsByLocation[normalizedLocation].push(event);
                } else if (!isEventPast(event) && event.name) {
                    // Missatge informatiu a la consola, no hi ha cap error greu
                    console.log(`Ubicació no trobada per a l'esdeveniment "${event.name}" a "${event.location}"`);
                }
            });

            // Afegeix marcadors per cada ubicació amb un o més esdeveniments
            for (const loc in eventsByLocation) {
                const eventsAtLocation = eventsByLocation[loc];
                const coords = locationCoordinates[loc];
                
                const marker = L.marker([coords.lat, coords.lon]).addTo(myMap);
                markers.push(marker);

                // Crea el contingut del popup dinàmicament
                let popupContent = `<div class="space-y-2">`;
                eventsAtLocation.forEach(event => {
                    popupContent += `
                        <div class="flex items-center space-x-2">
                            <img src="${event.imageUrl}" alt="${event.name}" class="w-16 h-16 rounded-full object-cover mb-2 border-2 border-indigo-500" onerror="this.onerror=null;this.src='https://placehold.co/64x64/6366f1/ffffff?text=Event';">
                            <div>
                                <h4 class="font-bold text-sm text-gray-900">${event.name}</h4>
                                <p class="text-xs text-indigo-600">${event.dateTime}</p>
                                <p class="text-xs text-gray-500">${event.location}</p>
                            </div>
                        </div>
                    `;
                });
                popupContent += `</div>`;
                
                marker.bindPopup(popupContent);
                // Si només hi ha un esdeveniment, mostra el popup automàticament
                if (eventsAtLocation.length === 1) {
                    marker.openPopup();
                }
            }
            
            // Ajusta el mapa per a que tots els marcadors siguin visibles
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                myMap.fitBounds(group.getBounds());
            }

            // Assegura que el mapa s'ajusti correctament a la mida del modal
            setTimeout(() => {
                myMap.invalidateSize();
            }, 100);

        }

        // Funció per amagar el modal del mapa
        function hideMap() {
            mapModal.classList.add('hidden');
        }

        // FUNCIÓ PER OBTENIR LA UBICACIÓ DE L'USUARI (si el navegador ho permet)
        function getUserLocation() {
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            userLocation = {
                                lat: position.coords.latitude,
                                lon: position.coords.longitude
                            };
                            statusMessageElement.textContent = 'Ubicació obtinguda!';
                            statusMessageElement.classList.remove('text-gray-500', 'text-red-500');
                            statusMessageElement.classList.add('text-green-500');
                            resolve(userLocation);
                        },
                        (error) => {
                            console.error("Error obtenint la ubicació:", error);
                            statusMessageElement.textContent = 'Error: Ubicació no disponible. Ordenant per data.';
                            statusMessageElement.classList.remove('text-gray-500', 'text-green-500');
                            statusMessageElement.classList.add('text-red-500');
                            userLocation = null;
                            resolve(null); // Resoldre amb null si hi ha un error
                        }
                    );
                } else {
                    statusMessageElement.textContent = 'Geolocation no és suportada pel teu navegador.';
                    statusMessageElement.classList.remove('text-gray-500', 'text-green-500');
                    statusMessageElement.classList.add('text-red-500');
                    resolve(null);
                }
            });
        }

        // FUNCIÓ PER CALCULAR LA DISTÀNCIA ENTRE DOS PUNTS (Fórmula de Haversine)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radi de la Terra en km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distància en km
        }

        // Funció per actualitzar l'estat dels botons de filtre
        function updateFilterButtons(type, order, mode) {
            filterTypeButtons.forEach(btn => {
                btn.classList.remove('bg-indigo-600');
                if (btn.dataset.filterType === type) {
                    btn.classList.add('bg-indigo-600');
                }
            });
            sortOrderButtons.forEach(btn => {
                btn.classList.remove('bg-indigo-600');
                if (btn.dataset.sortOrder === order) {
                    btn.classList.add('bg-indigo-600');
                }
            });
            filterModeButtons.forEach(btn => {
                btn.classList.remove('bg-indigo-600');
                if (btn.dataset.filterMode === mode) {
                    btn.classList.add('bg-indigo-600');
                }
            });
        }
        
        // Funció principal per filtrar i renderitzar els esdeveniments
        async function renderEvents(initialFilter = 'all') {
            eventsContainer.innerHTML = '';
            
            // Si estem ordenant per proximitat i ja tenim les dades de l'usuari
            if (currentSortOrder === 'proximity' && userLocation) {
                statusMessageElement.textContent = 'Ordenant per proximitat.';
            } else {
                 statusMessageElement.textContent = 'Ordenant per data.';
            }


            let filteredEvents = allEventsData;
            
            // PRIMER FILTRE: PER VISIBILITAT (futurs/recents o passats antics)
            if (currentFilterMode === 'upcoming') {
                filteredEvents = filteredEvents.filter(event => !isOldPastEvent(event));
            } else if (currentFilterMode === 'past') {
                filteredEvents = filteredEvents.filter(event => isOldPastEvent(event));
            }

            // SEGON FILTRE: PER TIPUS (Swing, Blues, etc.)
            if (currentFilterType !== 'all') {
                const typesToFilter = eventTypeMapping[currentFilterType] || [];
                filteredEvents = filteredEvents.filter(event => {
                    const eventType = event.type || '';
                    return typesToFilter.some(type => eventType.includes(type));
                });
            } else {
                // Filtre principal (Agost/Setembre) només si no hi ha filtre de tipus
                if (initialFilter === 'august-september') {
                    filteredEvents = filteredEvents.filter(event => {
                        if (!event.startDate) return false;
                        const { monthName } = getMonthAndDay(event.startDate);
                        return monthName === 'Agost' || monthName === 'Setembre';
                    });
                }
            }

            // APLICAR L'ORDENACIÓ
            if (currentSortOrder === 'proximity' && userLocation) {
                // Ordenar per proximitat
                filteredEvents.sort((a, b) => {
                    const aCoords = locationCoordinates[normalizeString(a.location)];
                    const bCoords = locationCoordinates[normalizeString(b.location)];

                    if (!aCoords) return 1;
                    if (!bCoords) return -1;
                    
                    const distA = calculateDistance(userLocation.lat, userLocation.lon, aCoords.lat, aCoords.lon);
                    const distB = calculateDistance(userLocation.lat, userLocation.lon, bCoords.lat, bCoords.lon);
                    
                    a.distance = distA;
                    b.distance = distB;
                    
                    return distA - distB;
                });
            } else {
                // Ordenar per data (per defecte)
                filteredEvents.sort((a, b) => {
                    if (!a.startDate || !b.startDate) return 0;
                    const [d1, m1, y1] = a.startDate.split('/');
                    const [d2, m2, y2] = b.startDate.split('/');
                    return new Date(y1, m1 - 1, d1) - new Date(y2, m2 - 1, d2);
                });
            }

            // Agrupar els esdeveniments per mes o per proximitat
            if (currentSortOrder === 'proximity' && userLocation) {
                if (filteredEvents.length > 0) {
                    const proximityGroupDiv = document.createElement('div');
                    proximityGroupDiv.className = "mb-8";
                    proximityGroupDiv.innerHTML = `<h2 class="text-3xl sm:text-5xl font-extrabold text-white mb-6">Resultats per proximitat</h2>`;
                    filteredEvents.forEach(event => {
                        const { day } = getMonthAndDay(event.startDate);
                        const cardElement = createEventCard(event, day);
                        proximityGroupDiv.appendChild(cardElement);
                    });
                    eventsContainer.appendChild(proximityGroupDiv);
                }
            } else {
                const eventsGroupedByMonth = {};
                filteredEvents.forEach(event => {
                    if (!event.startDate) return;
                    const { day, monthName, year } = getMonthAndDay(event.startDate);
                    const monthYear = `${monthName} ${year}`;
                    if (!eventsGroupedByMonth[monthYear]) {
                        eventsGroupedByMonth[monthYear] = {};
                    }
                    if (!eventsGroupedByMonth[monthYear][day]) {
                        eventsGroupedByMonth[monthYear][day] = [];
                    }
                    eventsGroupedByMonth[monthYear][day].push(event);
                });

                const monthOrder = ["Juliol", "Agost", "Setembre"];
                const sortedMonths = Object.keys(eventsGroupedByMonth).sort((a, b) => {
                    const monthA = a.split(' ')[0];
                    const monthB = b.split(' ')[0];
                    const indexA = monthOrder.indexOf(monthA);
                    const indexB = monthOrder.indexOf(monthB);
                    return indexA - indexB;
                });
                
                sortedMonths.forEach(monthYear => {
                    const monthGroupDiv = document.createElement('div');
                    monthGroupDiv.className = "mb-8";
                    monthGroupDiv.innerHTML = `<h2 class="text-3xl sm:text-5xl font-extrabold text-white mb-6">${monthYear}</h2>`;

                    const sortedDays = Object.keys(eventsGroupedByMonth[monthYear]).sort((a, b) => parseInt(a) - parseInt(b));

                    sortedDays.forEach(day => {
                        eventsGroupedByMonth[monthYear][day].forEach(event => {
                            const cardElement = createEventCard(event, day);
                            monthGroupDiv.appendChild(cardElement);
                        });
                    });
                    eventsContainer.appendChild(monthGroupDiv);
                });
            }

            if (filteredEvents.length === 0) {
                eventsContainer.innerHTML = '<p class="text-center text-xl text-gray-400">No s\'han trobat esdeveniments.</p>';
            }
            updateFilterButtons(currentFilterType, currentSortOrder, currentFilterMode);
        }

        // LISTENERS D'ESDEVENIMENTS
        closeModalBtn.addEventListener('click', hideEventDetail);
        closeMapBtn.addEventListener('click', hideMap); // Listener per tancar el mapa
        
        // Listener per a la capçalera desplegable del filtre
        toggleFilterHeaderBtn.addEventListener('click', () => {
            filterContent.classList.toggle('hidden');
            filterChevron.classList.toggle('rotate-180'); // Rotate chevron icon
        });

        filterTypeButtons.forEach(button => {
            button.addEventListener('click', () => {
                currentFilterType = button.dataset.filterType;
                renderEvents(); // Renderitza amb el nou filtre de tipus
            });
        });

        sortOrderButtons.forEach(button => {
            button.addEventListener('click', async () => {
                const newSortOrder = button.dataset.sortOrder;
                if (newSortOrder === 'proximity') {
                    if (!userLocation) {
                        statusMessageElement.textContent = 'Obtenint la teva ubicació...';
                        statusMessageElement.classList.remove('text-gray-500', 'text-green-500', 'text-red-500');
                        statusMessageElement.classList.add('text-gray-500');
                        await getUserLocation(); // Espera a obtenir la ubicació
                        if (userLocation) {
                            currentSortOrder = newSortOrder;
                            renderEvents();
                        } else {
                            // Si no hi ha ubicació, tornem a l'ordenació per data
                            currentSortOrder = 'date';
                            renderEvents();
                        }
                    } else {
                        currentSortOrder = newSortOrder;
                        renderEvents();
                    }
                } else {
                    currentSortOrder = newSortOrder;
                    renderEvents();
                }
            });
        });
        
        filterModeButtons.forEach(button => {
            button.addEventListener('click', () => {
                currentFilterMode = button.dataset.filterMode;
                renderEvents();
            });
        });
        
        showMapBtn.addEventListener('click', showMap); // Listener per mostrar el mapa

        // Càrrega inicial de les dades i renderització
        async function init() {
            loadingMessage.classList.remove('hidden');
            statusMessageElement.textContent = 'Carregant dades...';
            allEventsData = await fetchAndParseEvents();
            statusMessageElement.textContent = 'Dades carregades. Geocodificant ubicacions...';
            
            // Geocodificar totes les adreces de forma asíncrona en paral·lel
            const locationsToGeocode = [...new Set(allEventsData.map(event => event.location))];
            const geocodePromises = locationsToGeocode.map(async (location) => {
                const coords = await geocodeAddress(location);
                if (coords) {
                    locationCoordinates[location] = coords;
                }
            });
            await Promise.all(geocodePromises);

            statusMessageElement.textContent = 'Geocodificació completa. Llest per a l\'acció.';

            loadingMessage.classList.add('hidden');
            // Intentar obtenir la ubicació de l'usuari a l'inici
            await getUserLocation();
            renderEvents();

            // Comprovar si hi ha un hash per obrir un modal d'esdeveniment
            if (window.location.hash) {
                const hash = window.location.hash.substring(1);
                if (hash.startsWith('event-')) {
                    const eventNameSlug = hash.substring(6);
                    const event = allEventsData.find(e => normalizeString(e.name).replace(/\s+/g, '-') === eventNameSlug);
                    if (event) {
                        showEventDetail(event);
                    }
                }
            }
        }
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
